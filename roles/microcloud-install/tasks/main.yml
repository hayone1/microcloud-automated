---
- name: Check if the resolved.conf exists
  stat:
    path: /etc/systemd/resolved.conf
  register: resolved_stat

- name: Install Microceph snap
  # when: "'microceph' not in ansible_facts.packages"
  snap:
    name: microceph
    channel: "{{microceph_channel | default('reef/stable') }}"
    classic: false

- name: Install Microovn snap
  # when: "'microovn' not in ansible_facts.packages"
  snap:
    name: microovn
    channel: '{{microovn_channel}}'
    classic: no

- name: Install Microcloud snap
  # when: "'microcloud' not in ansible_facts.packages"
  snap:
    name: microcloud
    channel: '{{microcloud_channel}}'
    classic: no

- name: Reboot
  ansible.builtin.reboot:

- name: Ping test all-to-all network connectivity
  command: |-
    ping -c 2 {{ ip_dest }}
  vars:
    index_key: "{{ hostvars[item]['index_key'] }}"
    ip_dest: '{{ lookup_subnet | ansible.utils.next_nth_usable(index_key | int) }}'
  loop: "{{ groups[ansible_limit] }}"
  register: ping_results
  retries: 3
  delay: 3
  until: ping_results.rc == 0

- name: Test mDNS all-to-all connectivity
  command: resolvectl query -4 {{peer_hostname}}.local
  vars:
    peer_hostname: "{{hostvars[item]['ansible_nodename']}}"
  loop: "{{ groups[ansible_limit] }}"
  register: mDNS_results
  retries: 3
  delay: 3
  until: mDNS_results.rc == 0
  when: resolved_stat.stat.exists

- name: Show Next Steps
  delegate_to: '{{ansible_play_hosts[0]}}'
  run_once: true
  debug:
    msg: >-
      use_preseed is set to false, you'll need
      to run 'microcloud init'on any of the servers
  when: use_preseed is defined and use_preseed != true

- name: Copy preseed file to first host
  delegate_to: '{{ansible_play_hosts[0]}}'
  run_once: true
  copy:
    src: ./infra-{{ansible_limit}}/preseed.yml
    dest: /tmp/infra-{{ansible_limit}}-preseed.yml
  when: use_preseed is not defined or use_preseed == true

- name: Initialize microcloud (only on first host)
  delegate_to: '{{ansible_play_hosts[0]}}'
  run_once: true
  shell:
    # cmd: microcloud init --address {{address}} --auto --debug --verbose # I give up on preseed
    cmd: >-
      cat /tmp/infra-{{ansible_limit}}-preseed.yml |
      microcloud init --address {{address}}
      --preseed --debug --verbose
    # --state-dir /var/snap/microcloud/common/state
  register: init_result
  ignore_errors: true
  vars:
    address: '{{ lookup_subnet | ansible.utils.next_nth_usable(index_key | int) }}'
  when: use_preseed is not defined or use_preseed == true
- debug:
    msg: '{{init_result.stdout_lines}}'
  run_once: true
  when: init_result is succeeded

- name: Show LXC Cluster
  when: init_result.rc == 0
  delegate_to: '{{ansible_play_hosts[0]}}'
  run_once: true
  command: lxc cluster list
  register: lxc_cluster
- debug:
    msg: "{{lxc_cluster.stdout_lines}}"
  when: init_result.rc == 0
