---

- name: Uninstall Microceph snap
  # when: "'microceph' not in ansible_facts.packages"
  snap:
    name: microceph
    state: absent

- name: Uninstall Microovn snap
  # when: "'microovn' not in ansible_facts.packages"
  snap:
    name: microovn
    state: absent

- name: Uninstall Microcloud snap
  # when: "'microcloud' not in ansible_facts.packages"
  snap:
    name: microcloud
    state: absent
  
- name: UnInstall LXD snap
  # when: "'lxd' not in ansible_facts.packages"
  snap:
    name: lxd
    state: absent
  
- name: Wipe filesystems on ceph_volume_paths
  when: >-
    ceph_volume_paths is defined and
    item != None and
    item != ""
  command: wipefs -a {{ item.path }}
  loop: '{{ ceph_volume_paths }}'

- name: Wipe local filesystems on local_volume_path
  when: >-
    local_volume_path is defined and
    local_volume_path != None and
    local_volume_path != ""
  command: wipefs -a {{ local_volume_path }}


- name: Remove netplan in remote host
  shell:
    cmd: rm -rf *-microcloud.yaml*
    chdir: /etc/netplan

- name: Apply netplan config
  shell: netplan generate && netplan apply
  vars:
    dest_netplan_file: /etc/netplan/10{{index_key}}-microcloud.yaml

- name: Unconditionally reboot the machine with all defaults
  ansible.builtin.reboot:
